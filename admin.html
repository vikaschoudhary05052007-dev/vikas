<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Choudhary Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .form-input { background-color: #1C1C1C; border-color: #444; }
        .form-input:focus { background-color: #222; border-color: #D4AF37; outline: none; box-shadow: none; --tw-ring-color: #D4AF37; }
        .btn-save { background-color: #D4AF37; color: #101010; }
        .btn-save:hover { background-color: #e6c569; }
        .gallery-preview-item { position: relative; }
        .gallery-preview-item .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; opacity: 0; transition: opacity 0.3s; cursor: pointer; }
        .gallery-preview-item:hover .delete-btn { opacity: 1; }
    </style>
</head>
<body class="bg-[#101010] text-gray-200">

    <div id="auth-section" class="min-h-screen flex items-center justify-center">
        <div class="bg-[#1C1C1C] p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center text-white mb-6">Admin Login</h1>
            <form id="login-form">
                <div class="mb-4"><label for="email" class="block mb-2">Email</label><input type="email" id="email" class="w-full p-3 rounded form-input" required></div>
                <div class="mb-6"><label for="password" class="block mb-2">Password</label><input type="password" id="password" class="w-full p-3 rounded form-input" required></div>
                <button type="submit" id="login-button" class="w-full py-3 rounded btn-save font-bold flex items-center justify-center"><span id="login-button-text">Login</span></button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
            </form>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="bg-[#1C1C1C] shadow-md"><div class="container mx-auto px-6 py-4 flex justify-between items-center"><h1 class="text-xl font-bold text-white">Choudhary Display - Content Manager</h1><button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Logout</button></div></header>

        <main class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                
                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">SEO & Site Settings</h2>
                    <form id="seo-form" class="space-y-4">
                        <div>
                            <label for="seo-title" class="block mb-2 text-sm">Site Title</label>
                            <input type="text" id="seo-title" placeholder="e.g., Choudhary Display - Party Specialist" class="w-full p-3 rounded form-input">
                        </div>
                        <div>
                            <label for="seo-description" class="block mb-2 text-sm">Meta Description</label>
                            <textarea id="seo-description" rows="3" placeholder="A short description of your business for search engines." class="w-full p-3 rounded form-input"></textarea>
                        </div>
                        <div>
                            <label for="seo-keywords" class="block mb-2 text-sm">Keywords (comma-separated)</label>
                            <input type="text" id="seo-keywords" placeholder="e.g., party decorator, wedding planner, event management" class="w-full p-3 rounded form-input">
                        </div>
                        <div class="pt-4">
                             <h3 class="text-lg font-semibold mb-2 text-white">Favicon</h3>
                             <p class="text-sm text-gray-400 mb-4">Upload a small, square image (e.g., .ico, .png). This is the icon in the browser tab.</p>
                             <div class="flex items-center space-x-4">
                                <div id="favicon-preview" class="w-10 h-10 bg-gray-700 rounded flex items-center justify-center text-gray-400">
                                   <span id="favicon-placeholder">Icon</span>
                                   <img id="favicon-img" src="" class="w-full h-full object-contain rounded hidden" alt="Favicon Preview">
                                </div>
                                <div>
                                   <input type="file" id="favicon-upload" accept="image/*" class="hidden">
                                   <label for="favicon-upload" id="favicon-upload-label" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                       Change Favicon
                                   </label>
                                </div>
                             </div>
                        </div>
                        <button type="submit" class="mt-4 px-6 py-2 rounded btn-save font-bold">Save SEO Settings</button>
                    </form>
                </div>

                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Hero Section</h2>
                    <form id="hero-form" class="space-y-4">
                        <input type="text" id="hero-title" placeholder="Hero Title (e.g., Creating Spectacular Events...)" class="w-full p-3 rounded form-input">
                        <textarea id="hero-subtitle" placeholder="Hero Subtitle (e.g., Your premier party specialists...)" class="w-full p-3 rounded form-input" rows="3"></textarea>
                        <button type="submit" class="px-6 py-2 rounded btn-save font-bold">Save Hero Text</button>
                    </form>
                </div>
                
                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-white">Business Logo</h2>
                     <p class="text-sm text-gray-400 mb-4">Upload a square logo. It will be saved automatically.</p>
                     <div class="flex items-center space-x-4">
                        <div id="logo-preview" class="w-20 h-20 bg-gray-700 rounded-full flex items-center justify-center text-gray-400">
                           <span id="logo-placeholder">No Logo</span>
                           <img id="logo-img" src="" class="w-full h-full object-cover rounded-full hidden" alt="Logo Preview">
                        </div>
                        <div>
                           <input type="file" id="logo-upload" accept="image/*" class="hidden">
                           <label for="logo-upload" id="logo-upload-label" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                               Change Logo
                           </label>
                        </div>
                     </div>
                </div>

                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-2">
                    <h2 class="text-2xl font-bold mb-4 text-white">About Section</h2>
                    <form id="about-form">
                        <textarea id="about-text" rows="5" class="w-full p-3 rounded form-input"></textarea>
                        <div class="mt-4 flex items-center space-x-4">
                            <button type="submit" class="px-6 py-2 rounded btn-save font-bold">Save About</button>
                            <button type="button" id="ai-generate-about" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">âœ¨ Generate with AI</button>
                        </div>
                    </form>
                </div>

                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Contact & Social</h2>
                    <form id="contact-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <input type="text" id="contact-address" placeholder="Address" class="w-full p-3 rounded form-input">
                        <input type="email" id="contact-email" placeholder="Email" class="w-full p-3 rounded form-input">
                        <input type="tel" id="contact-phone" placeholder="Phone" class="w-full p-3 rounded form-input">
                        <input type="url" id="contact-instagram" placeholder="Instagram URL" class="w-full p-3 rounded form-input">
                        <input type="url" id="contact-facebook" placeholder="Facebook URL" class="w-full p-3 rounded form-input">
                        <input type="url" id="contact-pinterest" placeholder="Pinterest URL" class="w-full p-3 rounded form-input">
                        <button type="submit" class="mt-2 px-6 py-2 rounded btn-save font-bold md:col-span-3">Save Contact</button>
                    </form>
                </div>

                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Services</h2>
                    <form id="services-form" class="space-y-4">
                        <input type="text" id="service-1" placeholder="Service 1 Title" class="w-full p-3 rounded form-input">
                        <input type="text" id="service-2" placeholder="Service 2 Title" class="w-full p-3 rounded form-input">
                        <input type="text" id="service-3" placeholder="Service 3 Title" class="w-full p-3 rounded form-input">
                        <input type="text" id="service-4" placeholder="Service 4 Title" class="w-full p-3 rounded form-input">
                         <div class="pt-2 flex items-center space-x-4">
                            <button type="submit" class="px-6 py-2 rounded btn-save font-bold">Save Services</button>
                            <button type="button" id="ai-generate-services" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">âœ¨ Suggest All Services with AI</button>
                        </div>
                    </form>
                </div>
                
                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Process Steps & Image</h2>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2 text-white">Process Section Image</h3>
                        <p class="text-sm text-gray-400 mb-4">This image appears next to the process steps. It is saved automatically on upload.</p>
                        <div class="flex items-center space-x-4">
                            <div id="process-img-preview" class="w-24 h-24 bg-gray-700 rounded-lg flex items-center justify-center text-gray-400 text-sm p-2 text-center">
                               <span id="process-img-placeholder">No Image</span>
                               <img id="process-img-tag" src="" class="w-full h-full object-cover rounded-lg hidden" alt="Process Image Preview">
                            </div>
                            <div>
                               <input type="file" id="process-img-upload" accept="image/*" class="hidden">
                               <label for="process-img-upload" id="process-img-upload-label" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                   Change Image
                               </label>
                            </div>
                         </div>
                    </div>
                    <form id="process-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="process-1-title" placeholder="Step 1 Title" class="w-full p-3 rounded form-input"><input type="text" id="process-1-desc" placeholder="Step 1 Description" class="w-full p-3 rounded form-input"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="process-2-title" placeholder="Step 2 Title" class="w-full p-3 rounded form-input"><input type="text" id="process-2-desc" placeholder="Step 2 Description" class="w-full p-3 rounded form-input"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="process-3-title" placeholder="Step 3 Title" class="w-full p-3 rounded form-input"><input type="text" id="process-3-desc" placeholder="Step 3 Description" class="w-full p-3 rounded form-input"></div>
                        <button type="submit" class="mt-2 px-6 py-2 rounded btn-save font-bold">Save Process Steps</button>
                    </form>
                </div>
                
                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Testimonials</h2>
                    <form id="testimonials-form" class="space-y-6">
                        <div class="p-4 border border-gray-700 rounded-md">
                            <h3 class="font-semibold mb-2">Testimonial 1</h3>
                            <textarea id="testimonial-1-quote" placeholder="Client Quote" class="w-full p-3 rounded form-input mb-2" rows="3"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="testimonial-1-name" placeholder="Client Name (e.g., Anjali & Rohan)" class="w-full p-3 rounded form-input">
                                <input type="text" id="testimonial-1-event" placeholder="Event & Date (e.g., Wedding, March 2025)" class="w-full p-3 rounded form-input">
                            </div>
                        </div>
                         <div class="p-4 border border-gray-700 rounded-md">
                            <h3 class="font-semibold mb-2">Testimonial 2</h3>
                            <textarea id="testimonial-2-quote" placeholder="Client Quote" class="w-full p-3 rounded form-input mb-2" rows="3"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="testimonial-2-name" placeholder="Client Name" class="w-full p-3 rounded form-input">
                                <input type="text" id="testimonial-2-event" placeholder="Event & Date" class="w-full p-3 rounded form-input">
                            </div>
                        </div>
                         <div class="p-4 border border-gray-700 rounded-md">
                            <h3 class="font-semibold mb-2">Testimonial 3</h3>
                            <textarea id="testimonial-3-quote" placeholder="Client Quote" class="w-full p-3 rounded form-input mb-2" rows="3"></textarea>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="testimonial-3-name" placeholder="Client Name" class="w-full p-3 rounded form-input">
                                <input type="text" id="testimonial-3-event" placeholder="Event & Date" class="w-full p-3 rounded form-input">
                            </div>
                        </div>
                        <button type="submit" class="mt-2 px-6 py-2 rounded btn-save font-bold">Save Testimonials</button>
                    </form>
                </div>

                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                    <h2 class="text-2xl font-bold mb-4 text-white">Google Map</h2>
                    <form id="map-form">
                        <label for="map-url" class="block mb-2 text-sm text-gray-400">Paste the full embed URL from Google Maps share option.</label>
                        <textarea id="map-url" rows="4" class="w-full p-3 rounded form-input"></textarea>
                        <button type="submit" class="mt-4 px-6 py-2 rounded btn-save font-bold">Save Map URL</button>
                    </form>
                </div>
                
                <div class="bg-[#1C1C1C] p-6 rounded-lg shadow-lg col-span-1 md:col-span-3">
                     <h2 class="text-2xl font-bold mb-4 text-white">Gallery Images</h2>
                     <p class="text-sm text-gray-400 mb-4">Upload images directly or add URLs. Click "Save Gallery" to update your site.</p>
                     <div class="flex items-center space-x-4 mb-4">
                        <input type="file" id="image-upload" multiple accept="image/*" class="hidden">
                        <label for="image-upload" id="upload-label" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Add Images via Upload</label>
                        <button type="button" id="add-url-field" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Add by URL</button>
                        <div id="upload-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                        <p id="upload-status" class="text-gray-400"></p>
                     </div>
                     <form id="gallery-form">
                        <div id="gallery-previews" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6"></div>
                        <div id="gallery-url-fields" class="space-y-2"></div>
                        <button type="submit" class="mt-4 px-6 py-2 rounded btn-save font-bold w-full">Save Gallery</button>
                    </form>
                </div>
            </div>
            <div id="toast-notification" class="fixed bottom-10 right-10 bg-green-500 text-white py-2 px-6 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">Saved!</div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "AIzaSyDOtz9ec2nid25VEUMoBzh3KlKWGWR5AnU",
          authDomain: "vikas-69155.firebaseapp.com",
          projectId: "vikas-69155",
          storageBucket: "vikas-69155.appspot.com",
          messagingSenderId: "911123585574",
          appId: "1:911123585574:web:42138071d4223a873064e7"
        };
        const IMGBB_API_KEY = '6f04973e8d5cdc28eb66d4d2c0291261';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH & UI ---
        const authSection = document.getElementById('auth-section');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        
        onAuthStateChanged(auth, user => {
            if (user) { adminPanel.classList.remove('hidden'); authSection.classList.add('hidden'); loadContent(); } 
            else { adminPanel.classList.add('hidden'); authSection.classList.remove('hidden'); }
        });
        loginForm.addEventListener('submit', async e => { 
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch(error) {
                console.error("Login failed:", error.code);
                loginError.textContent = 'Invalid credentials. Please try again.';
            }
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        
        const toast = document.getElementById('toast-notification');
        function showToast(message = 'Saved!') { toast.textContent = message; toast.classList.remove('opacity-0'); setTimeout(() => toast.classList.add('opacity-0'), 3000); }

        const contentRef = doc(db, 'websiteContent', 'main');
        
        // --- FORM SELECTORS ---
        const aboutForm = document.getElementById('about-form');
        const contactForm = document.getElementById('contact-form');
        const servicesForm = document.getElementById('services-form');
        const processForm = document.getElementById('process-form');
        const testimonialsForm = document.getElementById('testimonials-form');
        const mapForm = document.getElementById('map-form');
        const heroForm = document.getElementById('hero-form');
        const seoForm = document.getElementById('seo-form');

        async function loadContent() {
            const docSnap = await getDoc(contentRef);
            if (!docSnap.exists()) return;
            const data = docSnap.data();

            // Load SEO
            document.getElementById('seo-title').value = data.seo?.title || '';
            document.getElementById('seo-description').value = data.seo?.description || '';
            document.getElementById('seo-keywords').value = data.seo?.keywords || '';
            const faviconImg = document.getElementById('favicon-img');
            const faviconPlaceholder = document.getElementById('favicon-placeholder');
            if (data.seo?.faviconUrl) {
                faviconImg.src = data.seo.faviconUrl;
                faviconImg.classList.remove('hidden');
                faviconPlaceholder.classList.add('hidden');
            }

            // Load Hero
            document.getElementById('hero-title').value = data.hero?.title || '';
            document.getElementById('hero-subtitle').value = data.hero?.subtitle || '';
            
            // Load About
            document.getElementById('about-text').value = data.aboutText || '';
            
            // Load Contact
            document.getElementById('contact-address').value = data.contactInfo?.address || '';
            document.getElementById('contact-email').value = data.contactInfo?.email || '';
            document.getElementById('contact-phone').value = data.contactInfo?.phone || '';
            document.getElementById('contact-instagram').value = data.socialLinks?.instagram || '';
            document.getElementById('contact-facebook').value = data.socialLinks?.facebook || '';
            document.getElementById('contact-pinterest').value = data.socialLinks?.pinterest || '';
            
            // Load Map
            document.getElementById('map-url').value = data.mapUrl || '';
            
            // Load Services & Process & Testimonials
            (data.services || []).forEach((s, i) => { if(document.getElementById(`service-${i+1}`)) document.getElementById(`service-${i+1}`).value = s; });
            (data.processSteps || []).forEach((s, i) => { if(document.getElementById(`process-${i+1}-title`)) { document.getElementById(`process-${i+1}-title`).value = s.title; document.getElementById(`process-${i+1}-desc`).value = s.description; } });
            (data.testimonials || []).forEach((t, i) => { if(document.getElementById(`testimonial-${i+1}-quote`)) { document.getElementById(`testimonial-${i+1}-quote`).value = t.quote; document.getElementById(`testimonial-${i+1}-name`).value = t.name; document.getElementById(`testimonial-${i+1}-event`).value = t.event; } });
            
            // Load Logo
            const logoImg = document.getElementById('logo-img');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            if (data.businessLogoUrl) {
                logoImg.src = data.businessLogoUrl;
                logoImg.classList.remove('hidden');
                logoPlaceholder.classList.add('hidden');
            } else {
                logoImg.classList.add('hidden');
                logoPlaceholder.classList.remove('hidden');
            }

            // Load Process Image
            const processImgTag = document.getElementById('process-img-tag');
            const processImgPlaceholder = document.getElementById('process-img-placeholder');
             if (data.processImageUrl) {
                processImgTag.src = data.processImageUrl;
                processImgTag.classList.remove('hidden');
                processImgPlaceholder.classList.add('hidden');
            } else {
                processImgTag.classList.add('hidden');
                processImgPlaceholder.classList.remove('hidden');
            }
            
            renderGalleryPreviews(data.galleryImages || []);
        }

        async function saveData(data) { await setDoc(contentRef, data, { merge: true }); showToast(); }
        
        // --- FORM SUBMISSIONS ---
        heroForm.addEventListener('submit', e => { e.preventDefault(); saveData({ hero: { title: document.getElementById('hero-title').value, subtitle: document.getElementById('hero-subtitle').value } }); });
        seoForm.addEventListener('submit', e => { e.preventDefault(); const currentSeoData = { title: document.getElementById('seo-title').value, description: document.getElementById('seo-description').value, keywords: document.getElementById('seo-keywords').value }; saveData({ seo: currentSeoData }); });
        aboutForm.addEventListener('submit', e => { e.preventDefault(); saveData({ aboutText: document.getElementById('about-text').value }); });
        contactForm.addEventListener('submit', e => { e.preventDefault(); saveData({ contactInfo: { address: document.getElementById('contact-address').value, email: document.getElementById('contact-email').value, phone: document.getElementById('contact-phone').value }, socialLinks: { instagram: document.getElementById('contact-instagram').value, facebook: document.getElementById('contact-facebook').value, pinterest: document.getElementById('contact-pinterest').value } }); });
        servicesForm.addEventListener('submit', e => { e.preventDefault(); const services = [document.getElementById('service-1').value, document.getElementById('service-2').value, document.getElementById('service-3').value, document.getElementById('service-4').value].filter(Boolean); saveData({ services }); });
        processForm.addEventListener('submit', e => { e.preventDefault(); const processSteps = [{ title: document.getElementById('process-1-title').value, description: document.getElementById('process-1-desc').value }, { title: document.getElementById('process-2-title').value, description: document.getElementById('process-2-desc').value }, { title: document.getElementById('process-3-title').value, description: document.getElementById('process-3-desc').value }].filter(s => s.title); saveData({ processSteps }); });
        testimonialsForm.addEventListener('submit', e => { e.preventDefault(); const testimonials = [{ quote: document.getElementById('testimonial-1-quote').value, name: document.getElementById('testimonial-1-name').value, event: document.getElementById('testimonial-1-event').value }, { quote: document.getElementById('testimonial-2-quote').value, name: document.getElementById('testimonial-2-name').value, event: document.getElementById('testimonial-2-event').value }, { quote: document.getElementById('testimonial-3-quote').value, name: document.getElementById('testimonial-3-name').value, event: document.getElementById('testimonial-3-event').value }].filter(t => t.quote); saveData({ testimonials }); });
        mapForm.addEventListener('submit', e => { e.preventDefault(); saveData({ mapUrl: document.getElementById('map-url').value }); });
        
        // --- IMAGE UPLOAD HANDLER ---
        async function handleImageUpload(file, uploadLabel, dataToSave, successCallback) {
            if (!file) return;
            uploadLabel.textContent = 'Uploading...';
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    await saveData({ ...dataToSave, [Object.keys(dataToSave)[0]]: result.data.url });
                    if(successCallback) successCallback(result.data.url);
                    showToast('Image updated!');
                } else { throw new Error(result.error.message); }
            } catch (error) { alert(`Image Upload Error: ${error.message}`); } finally { uploadLabel.textContent = 'Change ' + uploadLabel.id.split('-')[1]; }
        }

        document.getElementById('logo-upload').addEventListener('change', (e) => handleImageUpload(e.target.files[0], document.getElementById('logo-upload-label'), { businessLogoUrl: '' }, (url) => {
            document.getElementById('logo-img').src = url;
            document.getElementById('logo-img').classList.remove('hidden');
            document.getElementById('logo-placeholder').classList.add('hidden');
        }));
        
        document.getElementById('process-img-upload').addEventListener('change', (e) => handleImageUpload(e.target.files[0], document.getElementById('process-img-upload-label'), { processImageUrl: '' }, (url) => {
            document.getElementById('process-img-tag').src = url;
            document.getElementById('process-img-tag').classList.remove('hidden');
            document.getElementById('process-img-placeholder').classList.add('hidden');
        }));

        document.getElementById('favicon-upload').addEventListener('change', (e) => handleImageUpload(e.target.files[0], document.getElementById('favicon-upload-label'), { seo: { faviconUrl: '' } }, (url) => {
            document.getElementById('favicon-img').src = url;
            document.getElementById('favicon-img').classList.remove('hidden');
            document.getElementById('favicon-placeholder').classList.add('hidden');
        }));


        // --- Gallery Management ---
        const galleryPreviewsContainer = document.getElementById('gallery-previews');
        const galleryUrlFieldsContainer = document.getElementById('gallery-url-fields');
        const imageUploadInput = document.getElementById('image-upload');
        const uploadStatus = document.getElementById('upload-status');
        const uploadSpinner = document.getElementById('upload-spinner');

        function createPreviewElement(url) {
            const div = document.createElement('div');
            div.className = 'gallery-preview-item';
            div.innerHTML = `<img src="${url}" class="w-full h-24 object-cover rounded-md"><button data-url="${url}" class="delete-btn bg-red-600 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center">&times;</button>`;
            div.querySelector('.delete-btn').onclick = () => { div.remove(); };
            return div;
        }

        function createUrlField() {
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `<input type="url" class="w-full p-3 rounded form-input gallery-url-input" placeholder="Paste image URL here"><button type="button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded remove-url-field">-</button>`;
            div.querySelector('.remove-url-field').onclick = () => div.remove();
            galleryUrlFieldsContainer.appendChild(div);
        }

        document.getElementById('add-url-field').addEventListener('click', createUrlField);
        
        function renderGalleryPreviews(urls) {
            galleryPreviewsContainer.innerHTML = '';
            (urls || []).forEach(url => galleryPreviewsContainer.appendChild(createPreviewElement(url)));
        }

        imageUploadInput.addEventListener('change', async (e) => {
            const files = e.target.files; if (!files.length) return;
            uploadSpinner.classList.remove('hidden');
            uploadStatus.textContent = `Uploading 0/${files.length}...`;

            for (let i = 0; i < files.length; i++) {
                const formData = new FormData();
                formData.append('image', files[i]);
                try {
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const result = await response.json();
                    if (result.success) {
                        galleryPreviewsContainer.appendChild(createPreviewElement(result.data.url));
                    } else { throw new Error(result.error.message); }
                } catch (error) { alert(`Upload Error: ${error.message}`); }
                uploadStatus.textContent = `Uploading ${i + 1}/${files.length}...`;
            }
            uploadSpinner.classList.add('hidden');
            uploadStatus.textContent = `Upload complete!`;
        });

        document.getElementById('gallery-form').addEventListener('submit', async e => {
            e.preventDefault();
            const previewImages = Array.from(galleryPreviewsContainer.querySelectorAll('.gallery-preview-item img')).map(img => img.src);
            const manualUrls = Array.from(galleryUrlFieldsContainer.querySelectorAll('.gallery-url-input')).map(input => input.value).filter(Boolean);
            const allImages = [...previewImages, ...manualUrls];
            await saveData({ galleryImages: allImages });
            renderGalleryPreviews(allImages);
            galleryUrlFieldsContainer.innerHTML = '';
        });

        loadContent();
    </script>
</body>
</html>
